<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trackium - Decentralized Cargo Tracking</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="stylesheet" href="./assets/css/styles.css">
<script type="text/javascript" src="./mds.js"></script>
<script src="./assets/js/database.js"></script>
<script src="./assets/js/contracts.js"></script>
<script src="./assets/js/blockchain.js"></script>
<script src="./assets/js/device-manager.js"></script>
<script src="./assets/js/location-tracker.js"></script>
<script src="./assets/js/qr-generator.js"></script>
<script src="./assets/js/ui-location.js"></script>
<script src="./assets/js/ui.js"></script>
<script src="./assets/js/trackium-life.js"></script>
<script src="./assets/js/device-registry.js"></script>
<script src="./assets/js/simulator.js"></script>
<!-- <script src="./assets/js/location-sync.js"></script> -->
</head>
<body>

        <!-- Header -->
<header class="app-header">
  <div class="header-left">
    <div class="logo-container">
      <!-- âœ… LOGO -->
      <img src="./assets/img/logo.png" alt="Trackium" class="logo-image" id="trackium-logo" onerror="this.style.display='none'">
      <h2 class="logo-text">Trackium</h2>
    </div>
    
    <!-- âœ… BLOCK INDICATOR -->
    <div class="block-indicator">
      <span class="block-indicator-icon">â›“ï¸</span>
      <span class="block-indicator-text" id="current-block">Block 0</span>
    </div>
  </div>
  
  <div class="header-right">
    <button class="icon-btn" onclick="showScreen('mode-selector')" title="Switch Mode">ğŸ”„</button>
    <button class="icon-btn" onclick="showScreen('settings')" title="Settings">âš™ï¸</button>
    <button class="icon-btn" onclick="showScreen('help')" title="Help">â“</button>
  </div>
</header>

<!-- Mode Selector (Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸) -->
<div id="mode-selector" class="screen">
  <div class="mode-selector-container">
    <div class="logo-large">
      <span style="font-size: 80px;">ğŸ“¦</span>
      <h1>TRACKIUM</h1>
      <p class="tagline">Choose Your Adventure</p>
    </div>
    
    <div class="mode-cards">
      <!-- Cargo Mode -->
      <div class="mode-card" onclick="selectMode('cargo')">
        <div class="mode-icon">ğŸšš</div>
        <h2>Trackium Cargo</h2>
        <p>Professional logistics tracking with blockchain proof-of-movement</p>
        <ul class="mode-features">
          <li>ğŸ“¦ Device Management</li>
          <li>ğŸ”’ Smart Lock Control</li>
          <li>â›“ï¸ Blockchain Proofs</li>
          <li>ğŸ“Š Shipment Analytics</li>
        </ul>
        <button class="mode-select-btn primary">Enter Cargo Mode</button>
      </div>
      
      <!-- Life Mode -->
      <div class="mode-card" onclick="selectMode('life')">
        <div class="mode-icon">ğŸ¯</div>
        <h2>Trackium Life</h2>
        <p>Gamified personal goals with location-based rewards</p>
        <ul class="mode-features">
          <li>ğŸ® Level Up System</li>
          <li>ğŸ† Location Goals</li>
          <li>ğŸ’° Earn Rewards</li>
          <li>ğŸ–ï¸ Collect NFTs</li>
        </ul>
        <button class="mode-select-btn primary">Enter Life Mode</button>
      </div>
    </div>
  </div>
</div>

<!-- ========== TRACKIUM LIFE SCREENS ========== -->

<!-- Life Dashboard -->
<div id="life-dashboard" class="screen">

    <!-- Life Hero -->
<div class="life-hero">
  <h2>ğŸ¯ Set Goals. Achieve. Get Rewarded!</h2>
  <p>
    Connect real-world locations with your personal ambitions. 
    Complete location-based goals and earn Minima rewards while leveling up.
  </p>
</div>

  <div class="life-content">
    <!-- User Profile Card -->
    <div class="life-profile-card">
      <div class="avatar-container">
<div class="avatar-display" id="life-avatar" style="background: #00A86B;">
  <span id="avatar-emoji">ğŸ¶</span>
</div>
        <button class="avatar-edit-btn" onclick="showAvatarCustomizer()">âœï¸</button>
      </div>
      
      <div class="profile-info">
        <h3 id="life-username">Loading...</h3>
        <div class="level-badge">
          <span class="level-icon">â­</span>
          <span>Level <span id="life-level">1</span></span>
        </div>
      </div>
      
      <div class="stats-row">
        <div class="stat-item">
          <div class="stat-icon">ğŸ¯</div>
          <div class="stat-content">
            <span class="stat-value" id="life-total-goals">0</span>
            <span class="stat-label">Total Goals</span>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon">âœ…</div>
          <div class="stat-content">
            <span class="stat-value" id="life-completed-goals">0</span>
            <span class="stat-label">Completed</span>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon">ğŸ”¥</div>
          <div class="stat-content">
            <span class="stat-value" id="life-current-streak">0</span>
            <span class="stat-label">Day Streak</span>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-content">
            <span class="stat-value" id="life-total-rewards">0</span>
            <span class="stat-label">Minima Earned</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Experience Progress -->
    <div class="experience-card">
      <div class="exp-header">
        <span>Experience</span>
        <span><span id="current-exp">0</span> / <span id="exp-for-next-level">150</span> XP</span>
      </div>
      <div class="exp-progress-bar">
        <div class="exp-progress-fill" id="exp-progress" style="width: 0%"></div>
      </div>
      <p class="exp-hint">Complete goals to gain experience and level up!</p>
    </div>

    <!-- Quick Actions -->
    <div class="life-actions">
      <button class="action-btn primary" onclick="showScreen('life-create-goal')">
        <span class="btn-icon">â•</span>
        <span>Create New Goal</span>
      </button>
      <button class="action-btn" onclick="showScreen('life-goals')">
        <span class="btn-icon">ğŸ“‹</span>
        <span>My Goals</span>
      </button>
      <button class="action-btn" onclick="showScreen('life-map')">
        <span class="btn-icon">ğŸ—ºï¸</span>
        <span>Goals Map</span>
      </button>
    </div>

      <!-- Ğ’ dashboard, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ Quick Actions -->

<!-- <div class="section" style="margin-top: 20px;">
  <h3 class="section-title">Mode Selection</h3>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
    <div class="mode-card-small" onclick="selectMode('cargo')" style="cursor: pointer; padding: 20px; background: var(--bg-light); border: 2px solid var(--border-color); border-radius: 12px; text-align: center; transition: all 0.3s;">
      <div style="font-size: 48px; margin-bottom: 10px;">ğŸšš</div>
      <h4 style="margin-bottom: 5px;">Trackium Cargo</h4>
      <p style="font-size: 12px; color: var(--text-secondary);">Professional logistics tracking</p>
    </div>
    
    <div class="mode-card-small" onclick="selectMode('life')" style="cursor: pointer; padding: 20px; background: var(--bg-light); border: 2px solid var(--border-color); border-radius: 12px; text-align: center; transition: all 0.3s;">
      <div style="font-size: 48px; margin-bottom: 10px;">ğŸ¯</div>
      <h4 style="margin-bottom: 5px;">Trackium Life</h4>
      <p style="font-size: 12px; color: var(--text-secondary);">Personal goals & rewards</p>
    </div>
  </div>
</div> -->

    <!-- Active Goals -->
    <div class="section">
      <h3 class="section-title">Active Goals</h3>
      <div id="life-active-goals" class="goals-grid"></div>
    </div>

    <!-- Recent Completions -->
    <div class="section">
      <h3 class="section-title">Recent Achievements</h3>
      <div id="life-recent-completions" class="completions-list"></div>
    </div>
  </div>
</div>

<!-- Create Goal Screen -->
<div id="life-create-goal" class="screen">
  <div class="screen-header">
    <button class="back-btn" onclick="showScreen('life-dashboard')">â† Back</button>
    <h2>Create New Goal</h2>
  </div>
  
  <div class="form-container">
    <div class="form-group">
      <label>Goal Title *</label>
      <input type="text" id="goal-title" class="form-input" placeholder="e.g., Morning Gym Session">
    </div>

    <div class="form-group">
      <label>Description</label>
      <textarea id="goal-description" class="form-input" rows="3" placeholder="Optional description..."></textarea>
    </div>

    <div class="form-group">
      <label>Category *</label>
      <select id="goal-category" class="form-input">
        <option value="fitness">ğŸ‹ï¸ Fitness</option>
        <option value="education">ğŸ“š Education</option>
        <option value="work">ğŸ’¼ Work</option>
        <option value="social">ğŸ‘¥ Social</option>
        <option value="hobby">ğŸ¨ Hobby</option>
        <option value="health">â¤ï¸ Health</option>
        <option value="general">ğŸ“ General</option>
      </select>
    </div>

    <div class="form-group">
      <label>Repeat Type *</label>
      <select id="goal-repeat" class="form-input">
        <option value="once">Once (Single achievement)</option>
        <option value="daily">Daily (Can complete once per day)</option>
        <option value="weekly">Weekly (Once per week)</option>
      </select>
    </div>

    <div class="form-group">
      <label>Target Location *</label>
      <div style="display: flex; gap: 10px;">
        <button type="button" class="secondary-btn" onclick="useCurrentLocation()">
          ğŸ“ Use Current Location
        </button>
        <button type="button" class="secondary-btn" onclick="selectLocationOnMap()">
          ğŸ—ºï¸ Select on Map
        </button>
      </div>
      <div id="selected-location" style="margin-top: 10px; padding: 10px; background: var(--bg-light); border-radius: 6px; display: none;">
        <p style="margin: 0; font-size: 13px;"><strong>Selected:</strong></p>
        <p style="margin: 5px 0 0; font-size: 13px;" id="location-display">No location selected</p>
      </div>
    </div>

    <div class="form-group">
      <label>Check-in Radius (meters)</label>
      <input type="number" id="goal-radius" class="form-input" value="100" min="10" max="1000">
      <p style="font-size: 13px; color: var(--text-secondary); margin-top: 5px;">
        How close you need to be to complete this goal
      </p>
    </div>

    <div class="form-group">
      <label>Estimated Distance from Home</label>
      <input type="number" id="goal-distance" class="form-input" placeholder="meters" readonly>
      <p style="font-size: 13px; color: var(--text-secondary); margin-top: 5px;">
        ğŸ’¡ Further goals earn higher rewards!
      </p>
    </div>

    <div class="reward-preview" style="padding: 15px; background: rgba(0, 168, 107, 0.1); border-left: 3px solid var(--success-green); border-radius: 6px; margin: 20px 0;">
      <p style="margin: 0; font-weight: 600;">ğŸ’° Estimated Reward</p>
      <p style="margin: 10px 0 0; font-size: 24px; font-weight: bold; color: var(--success-green);">
        <span id="reward-preview">10</span> Minima
      </p>
      <p style="margin: 5px 0 0; font-size: 13px; color: var(--text-secondary);">
        + <span id="exp-preview">100</span> XP
      </p>
    </div>

    <button class="primary-btn full-width" onclick="createLifeGoal()">
      <span>Create Goal</span>
    </button>
  </div>
</div>

<!-- My Goals Screen -->
<div id="life-goals" class="screen">
  <div class="screen-header">
    <button class="back-btn" onclick="showScreen('life-dashboard')">â† Back</button>
    <h2>My Goals</h2>
    <div style="display: flex; gap: 10px;">
      <select id="goals-filter" class="form-input" style="width: 150px;" onchange="filterGoals()">
        <option value="all">All Goals</option>
        <option value="active">Active</option>
        <option value="completed">Completed</option>
      </select>
      <select id="goals-category-filter" class="form-input" style="width: 150px;" onchange="filterGoals()">
        <option value="all">All Categories</option>
        <option value="fitness">Fitness</option>
        <option value="education">Education</option>
        <option value="work">Work</option>
        <option value="social">Social</option>
        <option value="hobby">Hobby</option>
        <option value="health">Health</option>
      </select>
    </div>
  </div>

  <div class="goals-list" id="all-goals-list"></div>
</div>

<!-- Goal Detail Screen -->
<div id="life-goal-detail" class="screen">
  <div class="screen-header">
    <button class="back-btn" onclick="showScreen('life-goals')">â† Back</button>
    <h2 id="goal-detail-title">Goal Details</h2>
    <button class="icon-btn" onclick="deleteLifeGoal(currentGoalId)">ğŸ—‘ï¸</button>
  </div>

  <div class="goal-detail-container">
    <div class="detail-section">
      <div class="goal-detail-header">
        <div class="goal-category-badge" id="goal-detail-category">ğŸ“ General</div>
        <div class="goal-status-badge" id="goal-detail-status">Active</div>
      </div>
      
      <p id="goal-detail-description" style="margin: 15px 0; line-height: 1.6;">No description</p>
      
      <div class="goal-stats-grid">
        <div class="goal-stat">
          <span class="goal-stat-label">Reward</span>
          <span class="goal-stat-value" id="goal-detail-reward">10 Minima</span>
        </div>
        <div class="goal-stat">
          <span class="goal-stat-label">Radius</span>
          <span class="goal-stat-value" id="goal-detail-radius">100m</span>
        </div>
        <div class="goal-stat">
          <span class="goal-stat-label">Repeat</span>
          <span class="goal-stat-value" id="goal-detail-repeat">Once</span>
        </div>
        <div class="goal-stat">
          <span class="goal-stat-label">Times Completed</span>
          <span class="goal-stat-value" id="goal-detail-completions">0</span>
        </div>
      </div>
    </div>

    <div class="detail-section">
      <h3>Target Location</h3>
      <div id="goal-map-container" class="map-container">
        <div class="map-placeholder">
          <span class="location-icon">ğŸ“</span>
          <p id="goal-coordinates">Loading...</p>
        </div>
      </div>
      <button class="secondary-btn full-width" onclick="openInMaps(currentGoalLat, currentGoalLng)">
        ğŸ—ºï¸ Open in Maps
      </button>
    </div>

    <div class="detail-section">
      <h3>Check In</h3>
      <div id="checkin-status" style="text-align: center; padding: 20px;">
        <p style="margin-bottom: 15px;">Click the button when you arrive at the location</p>
        <button class="primary-btn" onclick="checkInAtGoal()" style="font-size: 18px; padding: 20px 40px;">
          ğŸ“ I'm Here - Check In
        </button>
      </div>
    </div>

    <div class="detail-section">
      <h3>Completion History</h3>
      <div id="goal-completion-history"></div>
    </div>
  </div>
</div>

<!-- Goals Map Screen -->
<div id="life-map" class="screen">
  <div class="screen-header">
    <button class="back-btn" onclick="showScreen('life-dashboard')">â† Back</button>
    <h2>Goals Map</h2>
  </div>

  <div class="map-view">
    <div class="map-filters">
      <button class="map-filter-btn active" data-filter="all" onclick="filterMapGoals('all')">All</button>
      <button class="map-filter-btn" data-filter="active" onclick="filterMapGoals('active')">Active</button>
      <button class="map-filter-btn" data-filter="completed" onclick="filterMapGoals('completed')">Completed</button>
    </div>
    
    <div id="goals-map-display" class="goals-map">
      <!-- Ğ—Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ° Ñ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ°Ğ¼Ğ¸ -->
      <div style="padding: 40px; text-align: center;">
        <p style="font-size: 48px; margin-bottom: 20px;">ğŸ—ºï¸</p>
        <p>Interactive map with goal markers</p>
        <p style="font-size: 13px; color: var(--text-secondary); margin-top: 10px;">
          Shows all your goals on a map with current location
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Profile Screen -->
<div id="life-profile" class="screen">
  <div class="screen-header">
    <button class="back-btn" onclick="showScreen('life-dashboard')">â† Back</button>
    <h2>Profile</h2>
    <button class="icon-btn" onclick="editProfile()">âœï¸</button>
  </div>

  <div class="profile-container">
    <!-- Avatar Section -->
    <div class="section">
      <h3>Avatar</h3>
      <div class="avatar-customizer">
        <div class="avatar-preview-large" id="profile-avatar-preview">
          <span id="profile-avatar-emoji" style="font-size: 80px;">ğŸ§‘</span>
        </div>
        <button class="secondary-btn" onclick="showAvatarCustomizer()">Customize Avatar</button>
      </div>
    </div>

    <!-- Profile Info -->
    <div class="section">
      <h3>Profile Information</h3>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="profile-username" class="form-input" placeholder="Your username">
      </div>
      <button class="primary-btn" onclick="saveProfile()">Save Changes</button>
    </div>

    <!-- Statistics -->
    <div class="section">
      <h3>Your Statistics</h3>
      <div class="stats-detailed">
        <div class="stat-detail-item">
          <span class="stat-detail-label">Total Goals Created</span>
          <span class="stat-detail-value" id="profile-total-goals">0</span>
        </div>
        <div class="stat-detail-item">
          <span class="stat-detail-label">Goals Completed</span>
          <span class="stat-detail-value" id="profile-completed-goals">0</span>
        </div>
        <div class="stat-detail-item">
          <span class="stat-detail-label">Success Rate</span>
          <span class="stat-detail-value" id="profile-success-rate">0%</span>
        </div>
        <div class="stat-detail-item">
          <span class="stat-detail-label">Current Streak</span>
          <span class="stat-detail-value" id="profile-current-streak">0 days</span>
        </div>
        <div class="stat-detail-item">
          <span class="stat-detail-label">Longest Streak</span>
          <span class="stat-detail-value" id="profile-longest-streak">0 days</span>
        </div>
        <div class="stat-detail-item">
          <span class="stat-detail-label">Total Rewards Earned</span>
          <span class="stat-detail-value" id="profile-total-rewards">0 Minima</span>
        </div>
        <div class="stat-detail-item">
          <span class="stat-detail-label">Total Experience</span>
          <span class="stat-detail-value" id="profile-total-exp">0 XP</span>
        </div>
        <div class="stat-detail-item">
          <span class="stat-detail-label">Member Since</span>
          <span class="stat-detail-value" id="profile-member-since">-</span>
        </div>
      </div>
    </div>

    <!-- Goals by Category -->
    <div class="section">
      <h3>Goals by Category</h3>
      <div id="profile-category-stats" class="category-stats"></div>
    </div>
  </div>
</div>

<!-- Achievements Screen -->
<div id="life-achievements" class="screen">
  <div class="screen-header">
    <button class="back-btn" onclick="showScreen('life-dashboard')">â† Back</button>
    <h2>Achievements & NFTs</h2>
  </div>

  <div class="achievements-container">
    <!-- Level NFTs -->
    <div class="section">
      <h3>Level Achievement NFTs</h3>
      <div id="level-nfts-grid" class="nfts-grid"></div>
    </div>

    <!-- Milestone Achievements -->
    <div class="section">
      <h3>Milestone Achievements</h3>
      <div id="milestones-grid" class="achievements-grid"></div>
    </div>
  </div>
</div>

<!-- Avatar Customizer Modal -->
<div id="avatar-customizer-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Customize Your Avatar</h3>
      <button class="close-btn" onclick="closeAvatarCustomizer()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="avatar-options">
        <h4>Choose Avatar</h4>
        <div class="avatar-emoji-grid">
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ§‘')">ğŸ§‘</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ‘¨')">ğŸ‘¨</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ‘©')">ğŸ‘©</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ§”')">ğŸ§”</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ‘´')">ğŸ‘´</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ‘µ')">ğŸ‘µ</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ§‘â€ğŸ“')">ğŸ§‘â€ğŸ“</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ‘¨â€ğŸ’¼')">ğŸ‘¨â€ğŸ’¼</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ‘©â€ğŸ’¼')">ğŸ‘©â€ğŸ’¼</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ‘¨â€ğŸ”§')">ğŸ‘¨â€ğŸ”§</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ‘©â€ğŸ”§')">ğŸ‘©â€ğŸ”§</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ¦¸')">ğŸ¦¸</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ¦¸â€â™‚ï¸')">ğŸ¦¸â€â™‚ï¸</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ¦¸â€â™€ï¸')">ğŸ¦¸â€â™€ï¸</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ§™')">ğŸ§™</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ§š')">ğŸ§š</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ§›')">ğŸ§›</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ§œ')">ğŸ§œ</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ§')">ğŸ§</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ¤–')">ğŸ¤–</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ‘½')">ğŸ‘½</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ±')">ğŸ±</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ¶')">ğŸ¶</button>
          <button class="avatar-emoji-btn" onclick="selectAvatar('ğŸ¼')">ğŸ¼</button>
        </div>
        
        <h4 style="margin-top: 20px;">Background Color</h4>
        <div class="color-picker-grid">
          <button class="color-btn" style="background: #0066CC;" onclick="selectColor('#0066CC')"></button>
          <button class="color-btn" style="background: #00A86B;" onclick="selectColor('#00A86B')"></button>
          <button class="color-btn" style="background: #FF8C00;" onclick="selectColor('#FF8C00')"></button>
          <button class="color-btn" style="background: #DC143C;" onclick="selectColor('#DC143C')"></button>
          <button class="color-btn" style="background: #9C27B0;" onclick="selectColor('#9C27B0')"></button>
          <button class="color-btn" style="background: #2196F3;" onclick="selectColor('#2196F3')"></button>
          <button class="color-btn" style="background: #4CAF50;" onclick="selectColor('#4CAF50')"></button>
          <button class="color-btn" style="background: #FF9800;" onclick="selectColor('#FF9800')"></button>
          <button class="color-btn" style="background: #E91E63;" onclick="selectColor('#E91E63')"></button>
          <button class="color-btn" style="background: #00BCD4;" onclick="selectColor('#00BCD4')"></button>
          <button class="color-btn" style="background: #8BC34A;" onclick="selectColor('#8BC34A')"></button>
          <button class="color-btn" style="background: #FFC107;" onclick="selectColor('#FFC107')"></button>
        </div>

        <div class="avatar-preview-container" style="margin-top: 30px; text-align: center;">
          <h4>Preview</h4>
          <div class="avatar-display" id="avatar-customizer-preview" style="margin: 20px auto;">
            <span id="customizer-avatar-emoji">ğŸ§‘</span>
          </div>
        </div>
      </div>

      <button class="primary-btn full-width" onclick="saveAvatarCustomization()">
        Save Avatar
      </button>
    </div>
  </div>
</div>

<style>
/* Mode Selector Styles */
.mode-selector-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 40px 20px;
  text-align: center;
}

.logo-large {
  margin-bottom: 60px;
}

.logo-large h1 {
  font-size: 56px;
  font-weight: 700;
  color: var(--primary-blue);
  margin: 20px 0 10px;
}

.mode-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
  margin-top: 40px;
}

.mode-card {
  background: var(--bg-medium);
  border: 3px solid var(--border-color);
  border-radius: 20px;
  padding: 40px;
  cursor: pointer;
  transition: all 0.3s;
  text-align: left;
}

.mode-card:hover {
  border-color: var(--primary-blue);
  transform: translateY(-8px);
  box-shadow: 0 20px 40px rgba(0, 102, 204, 0.3);
}

.mode-icon {
  font-size: 80px;
  margin-bottom: 20px;
}

.mode-card h2 {
  font-size: 32px;
  margin-bottom: 15px;
}

.mode-card p {
  color: var(--text-secondary);
  margin-bottom: 20px;
  line-height: 1.6;
}

.mode-features {
  list-style: none;
  padding: 0;
  margin: 20px 0;
}

.mode-features li {
  padding: 10px 0;
  border-bottom: 1px solid var(--border-color);
  font-size: 15px;
}

.mode-select-btn {
  margin-top: 20px;
  width: 100%;
  padding: 15px;
  font-size: 16px;
  font-weight: 600;
}

/* Life Mode Specific Styles */
.life-content {
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.life-profile-card {
  background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
  border-radius: 20px;
  padding: 30px;
  margin-bottom: 20px;
  color: white;
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 20px;
  align-items: center;
}

.avatar-container {
  position: relative;
}

.avatar-display {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 60px;
  border: 4px solid rgba(255, 255, 255, 0.3);
}

.avatar-edit-btn {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--success-green);
  border: 2px solid white;
  color: white;
  cursor: pointer;
  font-size: 14px;
}

.profile-info h3 {
  font-size: 28px;
  margin-bottom: 10px;
}

.level-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: rgba(255, 255, 255, 0.2);
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 600;
}

.stats-row {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.stat-item {
  background: rgba(255, 255, 255, 0.15);
  padding: 15px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.stat-icon {
  font-size: 32px;
}

.stat-content {
  display: flex;
  flex-direction: column;
}

.stat-value {
  font-size: 24px;
  font-weight: 700;
}

.stat-label {
  font-size: 12px;
  opacity: 0.8;
}

/* Experience Card */
.experience-card {
  background: var(--bg-medium);
  border: 2px solid var(--border-color);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.exp-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-weight: 600;
}

.exp-progress-bar {
  width: 100%;
  height: 20px;
  background: var(--bg-light);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 10px;
}

.exp-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--success-green), var(--primary-blue));
  transition: width 0.5s ease;
}

.exp-hint {
  font-size: 13px;
  color: var(--text-secondary);
  margin: 0;
}

/* Goals Grid */
.goals-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.goal-card {
  background: var(--bg-medium);
  border: 2px solid var(--border-color);
  border-radius: 12px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.goal-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: var(--primary-blue);
}

.goal-card.completed::before {
  background: var(--success-green);
}

.goal-card:hover {
  border-color: var(--primary-blue);
  transform: translateY(-4px);
}

.goal-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.goal-category-badge {
  display: inline-block;
  padding: 6px 12px;
  background: rgba(0, 102, 204, 0.2);
  color: var(--primary-blue);
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.goal-status-badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
}

.goal-status-badge.active {
  background: rgba(0, 168, 107, 0.2);
  color: var(--success-green);
}

.goal-status-badge.completed {
  background: rgba(100, 100, 100, 0.2);
  color: #aaa;
}

.goal-card h4 {
  font-size: 18px;
  margin-bottom: 10px;
}

.goal-card p {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 15px;
  line-height: 1.5;
}

.goal-info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-top: 1px solid var(--border-color);
  font-size: 13px;
}

.goal-reward {
  color: var(--success-green);
  font-weight: 600;
}

/* Completions List */
.completions-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.completion-item {
  background: var(--bg-medium);
  border: 2px solid var(--border-color);
  border-left: 4px solid var(--success-green);
  border-radius: 12px;
  padding: 20px;
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 20px;
  align-items: center;
}

.completion-icon {
  font-size: 48px;
}

.completion-info h4 {
  margin-bottom: 5px;
}

.completion-info p {
  font-size: 13px;
  color: var(--text-secondary);
  margin: 3px 0;
}

.completion-rewards {
  text-align: right;
}

.completion-rewards p {
  font-size: 14px;
  margin: 3px 0;
}

.completion-rewards .reward-amount {
  font-size: 20px;
  font-weight: 700;
  color: var(--success-green);
}

/* Goal Detail */
.goal-detail-container {
  padding: 20px;
  max-width: 900px;
  margin: 0 auto;
}

.goal-detail-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.goal-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.goal-stat {
  background: var(--bg-light);
  padding: 15px;
  border-radius: 8px;
  text-align: center;
}

.goal-stat-label {
  display: block;
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 5px;
}

.goal-stat-value {
  display: block;
  font-size: 20px;
  font-weight: 700;
  color: var(--primary-blue);
}

/* Map View */
.map-view {
  height: calc(100vh - 120px);
  display: flex;
  flex-direction: column;
}

.map-filters {
  display: flex;
  gap: 10px;
  padding: 15px;
  background: var(--bg-medium);
  border-bottom: 2px solid var(--border-color);
}

.map-filter-btn {
  padding: 10px 20px;
  background: transparent;
  border: 2px solid var(--border-color);
  color: var(--text-primary);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 14px;
  font-weight: 600;
}

.map-filter-btn.active,
.map-filter-btn:hover {
  background: var(--primary-blue);
  border-color: var(--primary-blue);
  color: white;
}

.goals-map {
  flex: 1;
  background: var(--bg-medium);
  position: relative;
}

/* Profile */
.profile-container {
  padding: 20px;
  max-width: 900px;
  margin: 0 auto;
}

.avatar-customizer {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.avatar-preview-large {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  background: var(--primary-blue);
  display: flex;
  align-items: center;
  justify-content: center;
  border: 4px solid var(--border-color);
}

.stats-detailed {
  display: grid;
  gap: 15px;
}

.stat-detail-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: var(--bg-light);
  border-radius: 8px;
}

.stat-detail-label {
  font-size: 14px;
  color: var(--text-secondary);
}

.stat-detail-value {
  font-size: 16px;
  font-weight: 700;
  color: var(--primary-blue);
}

.category-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.category-stat-card {
  background: var(--bg-light);
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}

.category-stat-card .category-icon {
  font-size: 40px;
  margin-bottom: 10px;
}

.category-stat-card h4 {
  margin-bottom: 10px;
  font-size: 16px;
}

.category-stat-card .stat-row {
  display: flex;
  justify-content: space-between;
  margin: 5px 0;
  font-size: 13px;
}

/* Achievements */
.achievements-container {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.nfts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
}

.nft-card {
  background: var(--bg-medium);
  border: 2px solid var(--border-color);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s;
}

.nft-card:hover {
  border-color: var(--primary-blue);
  transform: translateY(-4px);
}

.nft-card.locked {
  opacity: 0.5;
  filter: grayscale(1);
}

.nft-icon {
  font-size: 64px;
  margin-bottom: 15px;
  display: block;
}

.nft-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 5px;
}

.nft-rarity {
  font-size: 12px;
  padding: 4px 12px;
  border-radius: 12px;
  display: inline-block;
  margin-top: 10px;
}

.nft-rarity.common {
  background: rgba(150, 150, 150, 0.2);
  color: #aaa;
}

.nft-rarity.uncommon {
  background: rgba(76, 175, 80, 0.2);
  color: #4CAF50;
}

.nft-rarity.rare {
  background: rgba(33, 150, 243, 0.2);
  color: #2196F3;
}

.nft-rarity.epic {
  background: rgba(156, 39, 176, 0.2);
  color: #9C27B0;
}

.nft-rarity.legendary {
  background: rgba(255, 152, 0, 0.2);
  color: #FF9800;
}

.achievements-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 20px;
}

.achievement-card {
  background: var(--bg-medium);
  border: 2px solid var(--border-color);
  border-radius: 12px;
  padding: 20px;
}

.achievement-card.unlocked {
  border-color: var(--success-green);
}

.achievement-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.achievement-icon {
  font-size: 48px;
}

.achievement-status {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
}

.achievement-status.unlocked {
  background: rgba(0, 168, 107, 0.2);
  color: var(--success-green);
}

.achievement-status.locked {
  background: rgba(100, 100, 100, 0.2);
  color: #aaa;
}

.achievement-card h4 {
  margin-bottom: 10px;
}

.achievement-card p {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 15px;
}

.achievement-progress {
  width: 100%;
  height: 8px;
  background: var(--bg-light);
  border-radius: 4px;
  overflow: hidden;
  margin-top: 10px;
}

.achievement-progress-fill {
  height: 100%;
  background: var(--success-green);
  transition: width 0.3s;
}

/* Avatar Customizer Modal */
.avatar-emoji-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
  gap: 10px;
  margin: 15px 0;
}

.avatar-emoji-btn {
  width: 60px;
  height: 60px;
  border: 2px solid var(--border-color);
  background: var(--bg-light);
  border-radius: 12px;
  font-size: 32px;
  cursor: pointer;
  transition: all 0.3s;
}

.avatar-emoji-btn:hover,
.avatar-emoji-btn.selected {
  border-color: var(--primary-blue);
  background: rgba(0, 102, 204, 0.2);
  transform: scale(1.1);
}

.color-picker-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
  gap: 10px;
  margin: 15px 0;
}

.color-btn {
  width: 50px;
  height: 50px;
  border: 3px solid var(--border-color);
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s;
}

.color-btn:hover,
.color-btn.selected {
  border-color: white;
  transform: scale(1.15);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Responsive */
@media (max-width: 768px) {
  .mode-cards {
    grid-template-columns: 1fr;
  }
  
  .life-profile-card {
    grid-template-columns: 1fr;
    text-align: center;
  }
  
  .avatar-container {
    margin: 0 auto;
  }
  
  .stats-row {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .goals-grid {
    grid-template-columns: 1fr;
  }
  
  .goal-detail-container,
  .profile-container,
  .achievements-container {
    padding: 15px;
  }
}

/* Animations */
@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.goal-card,
.completion-item,
.nft-card,
.achievement-card {
  animation: slideInUp 0.3s ease;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
}

.level-badge {
  animation: pulse 2s infinite;
}
</style>

<script>
// Global variables for Life Mode
let lifeSystem = null;
let currentGoalId = null;
let currentGoalLat = null;
let currentGoalLng = null;
let selectedAvatarEmoji = 'ğŸ§‘';
let selectedAvatarColor = '#0066CC';
let homeLocation = { lat: null, lng: null };
let currentLocation = { lat: null, lng: null };

// Mode Selection
function selectMode(mode) {
  console.log('ğŸ“ Selecting mode:', mode);
  
  // Save mode preference
  localStorage.setItem('trackium_mode', mode);
  
  document.getElementById('mode-selector')?.classList.remove('active');
  
  if (mode === 'cargo') {
    showScreen('dashboard');
  } else {
    initLifeMode();
  }
}

function switchMode() {
  const currentMode = localStorage.getItem('trackium_mode');
  
  if (confirm(`Switch to ${currentMode === 'cargo' ? 'Life' : 'Cargo'} mode?`)) {
    if (currentMode === 'cargo') {
      selectMode('life');
    } else {
      selectMode('cargo');
    }
  }
}

// Initialize Life Mode
async function initLifeMode() {
  console.log('ğŸ® Initializing Trackium Life...');
  
  // ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ: Ğ•ÑĞ»Ğ¸ Ğ±Ğ°Ğ·Ğ° Ğ½Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° - Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ°Ñ‚ÑŒ
  if (!window.db || !db.initialized) {
    console.log('â³ Waiting for database...');
    
    // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ·Ñƒ ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
    if (!window.db) {
      window.db = new TrackiumDatabase();
      await new Promise((resolve) => {
        db.init((success) => {
          if (success) {
            console.log('âœ… Database initialized for Life mode');
            resolve();
          } else {
            console.error('âŒ Database init failed');
            resolve(); // ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°
          }
        });
      });
    }
  }
  
  if (!window.TrackiumLife) {
    console.error('TrackiumLife class not loaded');
    return;
  }
  
  // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
  lifeSystem = new TrackiumLife(window.db, window.blockchain);
  
  // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ
  await lifeSystem.initUserProfile((user) => {
    console.log('ğŸ‘¤ User profile loaded:', user);
    updateLifeUI(user);
    loadActiveGoals();
    loadRecentCompletions();
    showScreen('life-dashboard');
  });
}

// Update Life UI with user data
function updateLifeUI(user) {
  // Profile Card
  document.getElementById('life-username').textContent = user.username;
  document.getElementById('life-level').textContent = user.level;
  document.getElementById('life-total-goals').textContent = user.total_goals;
  document.getElementById('life-completed-goals').textContent = user.completed_goals;
  document.getElementById('life-current-streak').textContent = user.current_streak;
  document.getElementById('life-total-rewards').textContent = user.total_rewards.toFixed(2);
  
  // Avatar
  selectedAvatarEmoji = user.avatar || 'ğŸ§‘';
  selectedAvatarColor = user.avatar_color || '#0066CC';
  updateAvatarDisplay();
  
  // Experience Progress
  const currentExp = user.experience;
  const expForNext = lifeSystem.getExpForLevel(user.level + 1);
  const progress = (currentExp / expForNext) * 100;
  
  document.getElementById('current-exp').textContent = currentExp;
  document.getElementById('exp-for-next-level').textContent = expForNext;
  document.getElementById('exp-progress').style.width = progress + '%';
}

// Update Avatar Display
function updateAvatarDisplay() {
  const avatars = document.querySelectorAll('#life-avatar, #profile-avatar-preview, #avatar-customizer-preview');
  
  avatars.forEach(avatar => {
    if (avatar) {
      avatar.style.background = selectedAvatarColor;
      const emoji = avatar.querySelector('span');
      if (emoji) emoji.textContent = selectedAvatarEmoji;
    }
  });
}

// Load Active Goals
function loadActiveGoals() {
  lifeSystem.getActiveGoals((goals) => {
    const container = document.getElementById('life-active-goals');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (goals.length === 0) {
      container.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
          <div style="font-size: 80px; margin-bottom: 20px;">ğŸ¯</div>
          <h3 style="margin-bottom: 10px;">No Active Goals</h3>
          <p style="color: var(--text-secondary); margin-bottom: 20px;">Create your first goal to start earning rewards!</p>
          <button class="primary-btn" onclick="showScreen('life-create-goal')">Create Goal</button>
        </div>
      `;
      return;
    }
    
    goals.forEach(goal => {
      const card = createGoalCard(goal);
      container.appendChild(card);
    });
  });
}

// Create Goal Card Element
function createGoalCard(goal) {
  const card = document.createElement('div');
  card.className = 'goal-card';
  card.onclick = () => showGoalDetail(goal.id);
  
  const categoryIcons = {
    fitness: 'ğŸ‹ï¸',
    education: 'ğŸ“š',
    work: 'ğŸ’¼',
    social: 'ğŸ‘¥',
    hobby: 'ğŸ¨',
    health: 'â¤ï¸',
    general: 'ğŸ“'
  };
  
  card.innerHTML = `
    <div class="goal-card-header">
      <div class="goal-category-badge">
        ${categoryIcons[goal.category] || 'ğŸ“'} ${goal.category}
      </div>
      <div class="goal-status-badge ${goal.status}">
        ${goal.status === 'active' ? 'âœ“ Active' : 'âœ“ Completed'}
      </div>
    </div>
    <h4>${goal.title}</h4>
    <p>${goal.description || 'No description'}</p>
    <div class="goal-info-row">
      <span>ğŸ“ Within ${goal.target_radius}m</span>
      <span class="goal-reward">ğŸ’° ${goal.reward_amount} Minima</span>
    </div>
    <div class="goal-info-row">
      <span>ğŸ”„ ${goal.repeat_type}</span>
      <span>${goal.times_completed || 0} completions</span>
    </div>
  `;
  
  return card;
}

// Load Recent Completions
function loadRecentCompletions() {
  lifeSystem.getUserStatistics((stats) => {
    const container = document.getElementById('life-recent-completions');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (stats.recentCompletions.length === 0) {
      container.innerHTML = `
        <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
          No completions yet. Complete goals to see them here!
        </p>
      `;
      return;
    }
    
    stats.recentCompletions.slice(0, 5).forEach(completion => {
      const item = document.createElement('div');
      item.className = 'completion-item';
      
      const categoryIcons = {
        fitness: 'ğŸ‹ï¸',
        education: 'ğŸ“š',
        work: 'ğŸ’¼',
        social: 'ğŸ‘¥',
        hobby: 'ğŸ¨',
        health: 'â¤ï¸',
        general: 'ğŸ“'
      };
      
      const date = new Date(completion.completed_at);
      
      item.innerHTML = `
        <div class="completion-icon">${categoryIcons[completion.category] || 'âœ…'}</div>
        <div class="completion-info">
          <h4>${completion.title}</h4>
          <p>${date.toLocaleDateString()} at ${date.toLocaleTimeString()}</p>
          <p>ğŸ“ ${completion.completed_lat.toFixed(6)}, ${completion.completed_lng.toFixed(6)}</p>
        </div>
        <div class="completion-rewards">
          <p class="reward-amount">+${completion.reward_earned} Minima</p>
          <p style="color: var(--primary-blue);">+${completion.experience_earned || 0} XP</p>
        </div>
      `;
      
      container.appendChild(item);
    });
  });
}

// Use Current Location
async function useCurrentLocation() {
  if (!navigator.geolocation) {
    alert('Geolocation is not supported by your browser');
    return;
  }
  
  ui.showNotification('Getting current location...', 'info');
  
  navigator.geolocation.getCurrentPosition(
    async (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      
      currentLocation = { lat, lng };
      
      // Show selected location
      const locationDisplay = document.getElementById('location-display');
      const selectedLocation = document.getElementById('selected-location');
      
      if (locationDisplay && selectedLocation) {
        const locationName = await getLocationNameFromCoords(lat, lng);
        locationDisplay.textContent = `${locationName} (${lat.toFixed(6)}, ${lng.toFixed(6)})`;
        selectedLocation.style.display = 'block';
      }
      
      // Calculate distance from home if set
      if (homeLocation.lat && homeLocation.lng) {
        const distance = lifeSystem.calculateDistance(
          homeLocation.lat, homeLocation.lng,
          lat, lng
        );
        document.getElementById('goal-distance').value = distance;
        updateRewardPreview();
      }
      
      ui.showNotification('Location selected!', 'success');
    },
    (error) => {
      console.error('Geolocation error:', error);
      ui.showNotification('Failed to get location', 'error');
    }
  );
}

// Select Location on Map (simplified)
function selectLocationOnMap() {
  alert('Map selection coming soon! Use "Current Location" for now.');
}

// Update Reward Preview
function updateRewardPreview() {
  const category = document.getElementById('goal-category').value;
  const distance = parseInt(document.getElementById('goal-distance').value) || 0;
  
  const goalData = {
    category: category,
    distanceFromHome: distance
  };
  
  const reward = lifeSystem.calculateReward(goalData);
  const exp = reward * 10;
  
  document.getElementById('reward-preview').textContent = reward;
  document.getElementById('exp-preview').textContent = exp;
}

// Create Life Goal
async function createLifeGoal() {
  const title = document.getElementById('goal-title').value;
  const description = document.getElementById('goal-description').value;
  const category = document.getElementById('goal-category').value;
  const repeatType = document.getElementById('goal-repeat').value;
  const radius = parseInt(document.getElementById('goal-radius').value);
  const distance = parseInt(document.getElementById('goal-distance').value) || 0;
  
  if (!title) {
    ui.showNotification('Please enter goal title', 'error');
    return;
  }
  
  if (!currentLocation.lat || !currentLocation.lng) {
    ui.showNotification('Please select target location', 'error');
    return;
  }
  
  const goalData = {
    title: title,
    description: description,
    latitude: currentLocation.lat,
    longitude: currentLocation.lng,
    radius: radius,
    category: category,
    repeatType: repeatType,
    distanceFromHome: distance
  };
  
  lifeSystem.createGoal(goalData, (goal) => {
    if (goal) {
      ui.showNotification('Goal created successfully!', 'success');
      
      // Reset form
      document.getElementById('goal-title').value = '';
      document.getElementById('goal-description').value = '';
      document.getElementById('selected-location').style.display = 'none';
      currentLocation = { lat: null, lng: null };
      
      // Reload dashboard
      initLifeMode();
    } else {
      ui.showNotification('Failed to create goal', 'error');
    }
  });
}

// Show Goal Detail
function showGoalDetail(goalId) {
  currentGoalId = goalId;
  
  db.sql(`SELECT * FROM life_goals WHERE id = ${goalId}`, async (res) => {
    if (!res.rows || res.rows.length === 0) {
      ui.showNotification('Goal not found', 'error');
      return;
    }
    
    const goal = res.rows[0];
    currentGoalLat = goal.target_lat;
    currentGoalLng = goal.target_lng;
    
    // Update UI
    document.getElementById('goal-detail-title').textContent = goal.title;
    document.getElementById('goal-detail-description').textContent = goal.description || 'No description';
    document.getElementById('goal-detail-category').textContent = `${getCategoryIcon(goal.category)} ${goal.category}`;
    document.getElementById('goal-detail-status').textContent = goal.status;
    document.getElementById('goal-detail-reward').textContent = `${goal.reward_amount} Minima`;
    document.getElementById('goal-detail-radius').textContent = `${goal.target_radius}m`;
    document.getElementById('goal-detail-repeat').textContent = goal.repeat_type;
    
    // Get completion count
    db.sql(`SELECT COUNT(*) as count FROM life_completions WHERE goal_id = ${goalId}`, (res2) => {
      const count = res2.rows?.[0]?.count || 0;
      document.getElementById('goal-detail-completions').textContent = count;
    });
    
    // Show coordinates
    const locationName = await getLocationNameFromCoords(goal.target_lat, goal.target_lng);
    document.getElementById('goal-coordinates').textContent = `${locationName}\n${goal.target_lat.toFixed(6)}, ${goal.target_lng.toFixed(6)}`;
    
    // Load completion history
    loadGoalCompletionHistory(goalId);
    
    showScreen('life-goal-detail');
  });
}

function getCategoryIcon(category) {
  const icons = {
    fitness: 'ğŸ‹ï¸',
    education: 'ğŸ“š',
    work: 'ğŸ’¼',
    social: 'ğŸ‘¥',
    hobby: 'ğŸ¨',
    health: 'â¤ï¸',
    general: 'ğŸ“'
  };
  return icons[category] || 'ğŸ“';
}

// Load Goal Completion History
function loadGoalCompletionHistory(goalId) {
  db.sql(`SELECT * FROM life_completions WHERE goal_id = ${goalId} ORDER BY completed_at DESC`, (res) => {
    const container = document.getElementById('goal-completion-history');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!res.rows || res.rows.length === 0) {
      container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No completions yet</p>';
      return;
    }
    
    res.rows.forEach(completion => {
      const date = new Date(completion.completed_at);
      const item = document.createElement('div');
      item.style.cssText = 'padding: 15px; background: var(--bg-light); border-radius: 8px; margin-bottom: 10px;';
      
      item.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <strong>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</strong>
          <span style="color: var(--success-green); font-weight: 600;">+${completion.reward_earned} Minima</span>
        </div>
        <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">
          ğŸ“ ${completion.completed_lat.toFixed(6)}, ${completion.completed_lng.toFixed(6)}
        </p>
      `;
      
      container.appendChild(item);
    });
  });
}

// Check In at Goal
async function checkInAtGoal() {
  if (!currentGoalId) {
    ui.showNotification('No goal selected', 'error');
    return;
  }
  
  // Get current location
  if (!navigator.geolocation) {
    ui.showNotification('Geolocation not supported', 'error');
    return;
  }
  
  ui.showNotification('Getting your location...', 'info');
  
  navigator.geolocation.getCurrentPosition(
    async (position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      
      console.log('ğŸ“ Current position:', lat, lng);
      console.log('ğŸ¯ Target position:', currentGoalLat, currentGoalLng);
      
      // Check goal completion
      lifeSystem.checkGoalCompletion(currentGoalId, lat, lng, (result) => {
        if (result.success) {
          // Success!
          showCompletionModal(result);
        } else {
          // Failed
          if (result.reason === 'Too far from target') {
            ui.showNotification(
              `You're ${result.distance}m away. Need to be within ${result.required}m`,
              'warning'
            );
          } else {
            ui.showNotification(result.reason, 'warning');
          }
        }
      });
    },
    (error) => {
      console.error('Geolocation error:', error);
      ui.showNotification('Failed to get your location', 'error');
    }
  );
}

// Show Completion Modal
function showCompletionModal(result) {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.style.zIndex = '10000';
  
  const levelUpHTML = result.levelUp ? `
    <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #FFD700, #FFA500); border-radius: 12px; text-align: center;">
      <p style="font-size: 48px; margin: 0;">ğŸ‰</p>
      <h3 style="margin: 10px 0; color: #000;">LEVEL UP!</h3>
      <p style="margin: 0; font-size: 24px; font-weight: bold; color: #000;">Level ${result.newLevel}</p>
      <p style="margin: 10px 0 0; font-size: 14px; color: #000;">You've earned a Level ${result.newLevel} NFT!</p>
    </div>
  ` : '';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>ğŸ¯ Goal Completed!</h3>
      </div>
      <div class="modal-body" style="text-align: center;">
        <div style="font-size: 80px; margin: 20px 0;">âœ…</div>
        <h2 style="margin-bottom: 10px;">Congratulations!</h2>
        <p style="color: var(--text-secondary); margin-bottom: 30px;">You've successfully completed this goal</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 30px 0;">
          <div style="padding: 20px; background: rgba(0, 168, 107, 0.1); border-radius: 12px;">
            <p style="font-size: 14px; color: var(--text-secondary); margin: 0 0 5px;">Reward</p>
            <p style="font-size: 28px; font-weight: bold; color: var(--success-green); margin: 0;">
              ${result.reward} Minima
            </p>
          </div>
          <div style="padding: 20px; background: rgba(0, 102, 204, 0.1); border-radius: 12px;">
            <p style="font-size: 14px; color: var(--text-secondary); margin: 0 0 5px;">Experience</p>
            <p style="font-size: 28px; font-weight: bold; color: var(--primary-blue); margin: 0;">
              +${result.experience} XP
            </p>
          </div>
        </div>
        
        ${levelUpHTML}
        
        <button class="primary-btn full-width" onclick="closeCompletionModal()">
          Awesome!
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Reload data
  setTimeout(() => {
    initLifeMode();
  }, 500);
}

function closeCompletionModal() {
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    if (modal.querySelector('.modal-header h3')?.textContent.includes('Goal Completed')) {
      modal.remove();
    }
  });
  
  showScreen('life-dashboard');
}

// Open in Maps
function openInMaps(lat, lng) {
  const url = `https://www.google.com/maps?q=${lat},${lng}`;
  window.open(url, '_blank');
}

// Delete Life Goal
function deleteLifeGoal(goalId) {
  if (!goalId || !confirm('Delete this goal? This cannot be undone.')) return;
  
  db.sql(`DELETE FROM life_goals WHERE id = ${goalId}`, (res) => {
    if (res.status) {
      ui.showNotification('Goal deleted', 'success');
      showScreen('life-goals');
      loadActiveGoals();
    } else {
      ui.showNotification('Failed to delete goal', 'error');
    }
  });
}

// Filter Goals
function filterGoals() {
  const statusFilter = document.getElementById('goals-filter')?.value || 'all';
  const categoryFilter = document.getElementById('goals-category-filter')?.value || 'all';
  
  let query = 'SELECT * FROM life_goals WHERE 1=1';
  
  if (statusFilter !== 'all') {
    query += ` AND status = '${statusFilter}'`;
  }
  
  if (categoryFilter !== 'all') {
    query += ` AND category = '${categoryFilter}'`;
  }
  
  query += ' ORDER BY created_at DESC';
  
  db.sql(query, (res) => {
    const container = document.getElementById('all-goals-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!res.rows || res.rows.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 60px;">
          <p style="color: var(--text-secondary);">No goals match your filters</p>
        </div>
      `;
      return;
    }
    
    res.rows.forEach(goal => {
      const card = createGoalCard(goal);
      container.appendChild(card);
    });
  });
}

// Avatar Customizer
function showAvatarCustomizer() {
  document.getElementById('avatar-customizer-modal').classList.add('active');
  
  // Set current avatar
  document.getElementById('customizer-avatar-emoji').textContent = selectedAvatarEmoji;
  document.getElementById('avatar-customizer-preview').style.background = selectedAvatarColor;
}

function closeAvatarCustomizer() {
  document.getElementById('avatar-customizer-modal').classList.remove('active');
}

function selectAvatar(emoji) {
  selectedAvatarEmoji = emoji;
  
  // Update preview
  document.getElementById('customizer-avatar-emoji').textContent = emoji;
  
  // Highlight selected
  document.querySelectorAll('.avatar-emoji-btn').forEach(btn => {
    btn.classList.remove('selected');
    if (btn.textContent === emoji) {
      btn.classList.add('selected');
    }
  });
}

function selectColor(color) {
  selectedAvatarColor = color;
  
  // Update preview
  document.getElementById('avatar-customizer-preview').style.background = color;
  
  // Highlight selected
  document.querySelectorAll('.color-btn').forEach(btn => {
    btn.classList.remove('selected');
    if (btn.style.background === color) {
      btn.classList.add('selected');
    }
  });
}

function saveAvatarCustomization() {
  if (!lifeSystem || !lifeSystem.currentUser) return;
  
  lifeSystem.updateUserProfile({
    avatar: selectedAvatarEmoji,
    avatar_color: selectedAvatarColor
  }, (success) => {
    if (success) {
      updateAvatarDisplay();
      ui.showNotification('Avatar updated!', 'success');
      closeAvatarCustomizer();
    } else {
      ui.showNotification('Failed to update avatar', 'error');
    }
  });
}

// Edit Profile
function editProfile() {
  const usernameInput = document.getElementById('profile-username');
  if (usernameInput) {
    usernameInput.readOnly = false;
    usernameInput.focus();
  }
}

function saveProfile() {
  const username = document.getElementById('profile-username')?.value;
  
  if (!username || username.trim() === '') {
    ui.showNotification('Please enter a username', 'error');
    return;
  }
  
  lifeSystem.updateUserProfile({ username: username }, (success) => {
    if (success) {
      ui.showNotification('Profile updated!', 'success');
      document.getElementById('life-username').textContent = username;
      document.getElementById('profile-username').readOnly = true;
    } else {
      ui.showNotification('Failed to update profile', 'error');
    }
  });
}

// Load Profile Data
function loadProfileData() {
  if (!lifeSystem || !lifeSystem.currentUser) return;
  
  const user = lifeSystem.currentUser;
  
  // Basic info
  document.getElementById('profile-username').value = user.username;
  document.getElementById('profile-total-goals').textContent = user.total_goals;
  document.getElementById('profile-completed-goals').textContent = user.completed_goals;
  
  const successRate = user.total_goals > 0 ? 
    ((user.completed_goals / user.total_goals) * 100).toFixed(1) : 0;
  document.getElementById('profile-success-rate').textContent = successRate + '%';
  
  document.getElementById('profile-current-streak').textContent = user.current_streak + ' days';
  document.getElementById('profile-longest-streak').textContent = user.longest_streak + ' days';
  document.getElementById('profile-total-rewards').textContent = user.total_rewards + ' Minima';
  
  const totalExp = user.experience + (lifeSystem.getExpForLevel(user.level) * (user.level - 1));
  document.getElementById('profile-total-exp').textContent = totalExp + ' XP';
  
  const memberDate = new Date(user.created_at);
  document.getElementById('profile-member-since').textContent = memberDate.toLocaleDateString();
  
  // Load category stats
  lifeSystem.getUserStatistics((stats) => {
    const container = document.getElementById('profile-category-stats');
    if (!container) return;
    
    container.innerHTML = '';
    
    Object.keys(stats.goalsByCategory).forEach(category => {
      const data = stats.goalsByCategory[category];
      const icon = getCategoryIcon(category);
      
      const card = document.createElement('div');
      card.className = 'category-stat-card';
      
      card.innerHTML = `
        <div class="category-icon">${icon}</div>
        <h4>${category}</h4>
        <div class="stat-row">
          <span>Completed:</span>
          <strong>${data.count}</strong>
        </div>
        <div class="stat-row">
          <span>Rewards:</span>
          <strong>${data.totalRewards} Minima</strong>
        </div>
      `;
      
      container.appendChild(card);
    });
  });
}

// Load Achievements
function loadAchievements() {
  if (!lifeSystem || !lifeSystem.currentUser) return;
  
  const user = lifeSystem.currentUser;
  
  // Load Level NFTs
  db.sql(`SELECT * FROM life_achievements WHERE user_id = ${user.id} AND type = 'level_up' ORDER BY level ASC`, (res) => {
    const container = document.getElementById('level-nfts-grid');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Show achieved levels
    const earnedLevels = (res.rows || []).map(a => a.level);
    
    // Show up to level 10 or current level + 3
    const maxLevel = Math.max(10, user.level + 3);
    
    for (let i = 1; i <= maxLevel; i++) {
      const earned = earnedLevels.includes(i);
      const rarity = lifeSystem.getLevelRarity(i);
      
      const card = document.createElement('div');
      card.className = `nft-card ${!earned ? 'locked' : ''}`;
      
      card.innerHTML = `
        <span class="nft-icon">${earned ? 'ğŸ–ï¸' : 'ğŸ”’'}</span>
        <div class="nft-title">Level ${i}</div>
        <div class="nft-rarity ${rarity.toLowerCase()}">${rarity}</div>
        ${!earned && i <= user.level ? '<p style="font-size: 12px; margin-top: 10px; color: var(--text-secondary);">Reach level ' + i + ' to unlock</p>' : ''}
      `;
      
      container.appendChild(card);
    }
  });
  
  // Load Milestone Achievements
  const milestones = [
    { id: 'first_goal', title: 'First Steps', desc: 'Complete your first goal', icon: 'ğŸ¯', requirement: 1 },
    { id: 'goals_10', title: 'Rising Star', desc: 'Complete 10 goals', icon: 'â­', requirement: 10 },
    { id: 'goals_50', title: 'Dedicated', desc: 'Complete 50 goals', icon: 'ğŸŒŸ', requirement: 50 },
    { id: 'goals_100', title: 'Legendary', desc: 'Complete 100 goals', icon: 'ğŸ‘‘', requirement: 100 },
    { id: 'streak_7', title: 'Week Warrior', desc: 'Maintain a 7-day streak', icon: 'ğŸ”¥', requirement: 7, streakType: true },
    { id: 'streak_30', title: 'Monthly Master', desc: 'Maintain a 30-day streak', icon: 'ğŸ†', requirement: 30, streakType: true },
    { id: 'rewards_100', title: 'Wealthy', desc: 'Earn 100 Minima', icon: 'ğŸ’°', requirement: 100, rewardType: true },
    { id: 'rewards_1000', title: 'Rich', desc: 'Earn 1000 Minima', icon: 'ğŸ’', requirement: 1000, rewardType: true }
  ];
  
  const container = document.getElementById('milestones-grid');
  if (!container) return;
  
  container.innerHTML = '';
  
  milestones.forEach(milestone => {
    let progress = 0;
    let unlocked = false;
    
    if (milestone.streakType) {
      progress = user.longest_streak;
      unlocked = progress >= milestone.requirement;
    } else if (milestone.rewardType) {
      progress = user.total_rewards;
      unlocked = progress >= milestone.requirement;
    } else {
      progress = user.completed_goals;
      unlocked = progress >= milestone.requirement;
    }
    
    const progressPercent = Math.min(100, (progress / milestone.requirement) * 100);
    
    const card = document.createElement('div');
    card.className = 'achievement-card';
    if (unlocked) card.classList.add('unlocked');
    
    card.innerHTML = `
      <div class="achievement-header">
        <span class="achievement-icon">${milestone.icon}</span>
        <span class="achievement-status ${unlocked ? 'unlocked' : 'locked'}">
          ${unlocked ? 'âœ“ Unlocked' : 'ğŸ”’ Locked'}
        </span>
      </div>
      <h4>${milestone.title}</h4>
      <p>${milestone.desc}</p>
      <div style="font-size: 13px; margin-top: 10px;">
        Progress: ${progress} / ${milestone.requirement}
      </div>
      <div class="achievement-progress">
        <div class="achievement-progress-fill" style="width: ${progressPercent}%"></div>
      </div>
    `;
    
    container.appendChild(card);
  });
}

// Filter Map Goals
function filterMapGoals(filter) {
  // Update active button
  document.querySelectorAll('.map-filter-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.filter === filter) {
      btn.classList.add('active');
    }
  });
  
  // TODO: Implement map filtering
  console.log('Filtering map goals:', filter);
}

// Initialize on screen show
// const originalShowScreen = window.showScreen;
// window.showScreen = function(screenId) {
//   originalShowScreen(screenId);
  
//   // Life Mode specific initializations
//   if (screenId === 'life-profile') {
//     loadProfileData();
//   } else if (screenId === 'life-achievements') {
//     loadAchievements();
//   } else if (screenId === 'life-goals') {
//     filterGoals();
//   }
// };

console.log('âœ… Trackium Life UI loaded');
</script>
    
    <!-- Loading Screen -->
    <div id="loading-screen" class="screen active">
        <div class="loading-container">
            <div class="trackium-logo">
                <div class="logo-icon">ğŸ“¦</div>
                <h1>TRACKIUM</h1>
                <p class="tagline">Trust the Movement. Secure the World.</p>
            </div>
            <div class="loading-spinner"></div>
            <p class="loading-text">Connecting to Minima Network...</p>
        </div>
    </div>

    <!-- Main Dashboard -->
<div id="dashboard" class="screen active">


    <!-- ===== HERO SECTION (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ dashboard) ===== -->
<section class="hero-section" id="hero-section" style="display: none;">
  <div class="hero-content">
    <h1 class="hero-title">Cargo Tracking and Security System</h1>
    <p class="hero-description">
      Trackium brings trust and real-time visibility to global logistics. 
      Built on Minima blockchain, our solution ensures every shipment is verifiable, 
      traceable, and tamper-proof â€” from origin to destination.
    </p>
    <div class="hero-actions">
      <button class="hero-btn primary" onclick="showScreen('devices')">
        ğŸ“± My Devices
      </button>
      <button class="hero-btn secondary" onclick="selectMode('life')">
        ğŸ¯ Try Trackium Life
      </button>
    </div>
  </div>
</section>

  <!-- Stats Cards -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-icon">ğŸ”—</div>
      <div class="stat-info">
        <span class="stat-value" id="total-devices">0</span>
        <span class="stat-label">Active Devices</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">ğŸšš</div>
      <div class="stat-info">
        <span class="stat-value" id="active-shipments">0</span>
        <span class="stat-label">Active Shipments</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">ğŸ”’</div>
      <div class="stat-info">
        <span class="stat-value" id="locked-devices">0</span>
        <span class="stat-label">Locked</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âœ…</div>
      <div class="stat-info">
        <span class="stat-value" id="verified-proofs">0</span>
        <span class="stat-label">Verified Proofs</span>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <button class="action-btn primary" onclick="showScreen('add-device')">
      <span class="btn-icon">â•</span>
      <span>Add Device</span>
    </button>
    <button class="action-btn" onclick="showScreen('devices')">
      <span class="btn-icon">ğŸ“±</span>
      <span>My Devices</span>
    </button>
    <button class="action-btn" onclick="showScreen('shipments')">
      <span class="btn-icon">ğŸ“¦</span>
      <span>Shipments</span>
    </button>
    <button class="action-btn" onclick="showScreen('analytics')">
      <span class="btn-icon">ğŸ“Š</span>
      <span>Analytics</span>
    </button>
  </div>

  <!-- Recent Activity -->
  <div class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3 class="section-title">Recent Activity</h3>
      
      <!-- Category Filter -->
      <div style="display: flex; gap: 10px; align-items: center;">
        <label style="font-size: 14px; color: var(--text-secondary);">Filter:</label>
        <select id="activity-category-filter" 
                class="form-input" 
                style="width: 200px; padding: 8px;"
                onchange="filterRecentActivity()">
          <option value="all">All Categories</option>
        </select>
      </div>
    </div>
    
    <div id="recent-activity" class="activity-list"></div>
  </div>
</div>

<script>
// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Ğ² Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€
function loadCategoryFilter() {
  if (!window.deviceManager) return;
  
  window.deviceManager.getAllCategories((categories) => {
    const select = document.getElementById('activity-category-filter');
    if (!select) return;
    
    // ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ĞºÑ€Ğ¾Ğ¼Ğµ "All"
    select.innerHTML = '<option value="all">All Categories</option>';
    
    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸
    categories.forEach(category => {
      if (category) {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
      }
    });
  });
}

// Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸
function filterRecentActivity() {
  const selectedCategory = document.getElementById('activity-category-filter').value;
  console.log('Filtering by category:', selectedCategory);
  
  if (!window.db) return;
  
  if (selectedCategory === 'all') {
    // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ²ÑĞµ
    window.db.getRecentActivity(10, (events) => {
      window.ui.renderRecentActivity(events);
    });
  } else {
    // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½ÑƒÑ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ
    window.db.getDevicesByCategory(selectedCategory, (devices) => {
      const deviceIds = devices.map(d => d.device_id || d.deviceId);
      
      // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ¸Ñ… ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²
      const query = `SELECT * FROM events 
                     WHERE device_id IN ('${deviceIds.join("','")}')
                     ORDER BY timestamp DESC 
                     LIMIT 10`;
      
      window.db.sql(query, (res) => {
        window.ui.renderRecentActivity(res.rows || []);
      });
    });
  }
}

window.loadCategoryFilter = loadCategoryFilter;
window.filterRecentActivity = filterRecentActivity;
</script>

<!-- Add Device Screen - ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞĞ¯ Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ¯ -->
<!-- Add Device Screen - UPDATED VERSION -->
<div id="add-device" class="screen">
  <div class="screen-header">
    <button class="back-btn" onclick="showScreen('dashboard')">â† Back</button>
    <h2>Add Trackium Device</h2>
  </div>
  
  <div class="form-container">
    
    <!-- Location Tracking Setup Block -->
    <div style="margin-bottom: 30px; padding: 20px; background: rgba(255, 140, 0, 0.1); border-left: 4px solid var(--warning-orange); border-radius: 8px;">
      <h3 style="color: var(--warning-orange); margin-bottom: 10px;">ğŸ“ Location Tracking Required</h3>
      <p style="margin-bottom: 15px; line-height: 1.6;">
        Trackium requires a location service to track device movement. During testing phase, 
        you need to install a companion service on your device.
      </p>
      <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">
        â„¹ï¸ <strong>Note:</strong> In production, Trackium hardware devices will have this service built-in.
      </p>
      
      <button class="primary-btn" onclick="showLocationServiceModal()" style="width: 100%; margin-bottom: 10px;">
        ğŸ“¥ Download Location Service
      </button>
      
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="secondary-btn" onclick="checkLocationServiceStatus()" style="flex: 1;">
          ğŸ”„ Check Status
        </button>
<button class="secondary-btn" onclick="testLocationAPI()" style="flex: 1;">
  ğŸ§ª Test Connection
</button>
      </div>
      
      <div id="location-service-status" style="margin-top: 15px; padding: 10px; background: var(--bg-light); border-radius: 6px; display: none;">
        <p style="font-size: 13px; margin: 0;"><strong>Status:</strong> <span id="service-status-text">Unknown</span></p>
        <p style="font-size: 13px; margin: 5px 0 0;"><strong>Last Update:</strong> <span id="service-last-update">Never</span></p>
      </div>
    </div>

    <!-- Device Type -->
    <div class="form-group">
      <label>Device Type / Role</label>
      <select id="device-type" class="form-input" onchange="updateDeviceTypeInfo()">
        <option value="tracker">ğŸ“¦ Tracker (NB-IoT)</option>
        <option value="smartlock">ğŸ”’ Smart Lock + Tracker</option>
        <option value="smartphone">ğŸ“± Smartphone (Testing)</option>
      </select>
      <p id="device-type-info" class="device-type-description"></p>
    </div>

    <!-- Transport Type -->
    <div class="form-group">
      <label>Transport Type</label>
      <select id="transport-type" class="form-input">
        <option value="ground">ğŸšš Ground (Truck/Car/Train)</option>
        <option value="sea">ğŸš¢ Sea (Ship/Boat)</option>
        <option value="air">âœˆï¸ Air (Plane/Drone)</option>
      </select>
    </div>

    <!-- Category -->
    <div class="form-group">
      <label>Category <span style="color: var(--text-secondary);">(optional)</span></label>
      <input 
        type="text" 
        id="device-category" 
        class="form-input" 
        placeholder="e.g., Electronics, Food, Medical"
        list="category-suggestions">
      <datalist id="category-suggestions">
        <option value="Electronics">
        <option value="Food & Beverages">
        <option value="Medical Supplies">
        <option value="Automotive Parts">
        <option value="Textiles">
        <option value="Industrial Equipment">
        <option value="Pharmaceuticals">
        <option value="Personal Items">
      </datalist>
    </div>

    <!-- Device ID -->
    <div class="form-group">
      <label>Device ID / Serial Number</label>
      <input type="text" id="device-id" class="form-input" placeholder="TRACK-XXXX-XXXX">
      <button class="secondary-btn" onclick="generateDeviceId()" style="margin-top: 8px;">
        ğŸ”„ Generate ID
      </button>
    </div>

    <!-- Device Name -->
    <div class="form-group">
      <label>Device Name</label>
      <input type="text" id="device-name" class="form-input" placeholder="e.g., Container-EU-01">
    </div>

    <!-- Location -->
    <div class="form-group">
      <label>Initial Location <span style="color: var(--text-secondary);">(optional)</span></label>
      <input type="text" id="device-location" class="form-input" placeholder="e.g., Warehouse A, Kyiv">
    </div>

    <!-- Blockchain Proof -->
    <div class="form-group">
      <label>
        <input type="checkbox" id="enable-blockchain-proof" checked>
        Enable Blockchain Proof-of-Movement
      </label>
    </div>
    
    <!-- Submit Button -->
    <button class="primary-btn full-width" onclick="addDevice()">
      <span>Register Device</span>
    </button>
  </div>
</div>

<!-- Location Service Download Modal -->
<div id="location-service-modal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h3>ğŸ“¥ Download Location Service</h3>
      <button class="close-btn" onclick="closeLocationServiceModal()">âœ•</button>
    </div>
    <div class="modal-body">
      
      <!-- Platform Selection -->
      <div style="margin-bottom: 30px;">
        <h4 style="color: var(--primary-blue); margin-bottom: 15px;">Select Your Platform:</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
          <button class="platform-btn" onclick="selectPlatform('macos')" data-platform="macos">
            <span style="font-size: 48px;">ğŸ</span>
            <p>macOS</p>
          </button>
          <button class="platform-btn" onclick="selectPlatform('windows')" data-platform="windows">
            <span style="font-size: 48px;">ğŸªŸ</span>
            <p>Windows</p>
          </button>
          <button class="platform-btn" onclick="selectPlatform('linux')" data-platform="linux">
            <span style="font-size: 48px;">ğŸ§</span>
            <p>Linux</p>
          </button>
          <button class="platform-btn" onclick="selectPlatform('android')" data-platform="android">
            <span style="font-size: 48px;">ğŸ¤–</span>
            <p>Android</p>
          </button>
        </div>
      </div>

      <!-- macOS Instructions -->
      <div id="instructions-macos" class="platform-instructions" style="display: none;">
        <h4>ğŸ macOS Installation</h4>
        <div class="accordion">
          <button class="accordion-btn" onclick="toggleAccordion(this)">
            Step 1: Download Service â†’
          </button>
          <div class="accordion-content">
            <button class="primary-btn" onclick="downloadLocationService('macos')" style="margin: 15px 0;">
              ğŸ“¥ Download trackium-location-service-macos.zip
            </button>
            <p style="font-size: 13px; color: var(--text-secondary);">
              Version 1.0.0 | Size: ~5MB | Requires: Node.js 16+
            </p>
          </div>

          <button class="accordion-btn" onclick="toggleAccordion(this)">
            Step 2: Install Node.js (if needed) â†’
          </button>
          <div class="accordion-content">
            <p>Check if Node.js is installed:</p>
            <pre style="background: var(--bg-dark); padding: 10px; border-radius: 4px; overflow-x: auto;">node --version</pre>
            <p>If not installed, download from: <a href="https://nodejs.org" target="_blank" style="color: var(--primary-blue);">nodejs.org</a></p>
          </div>

          <button class="accordion-btn" onclick="toggleAccordion(this)">
            Step 3: Run Service â†’
          </button>
          <div class="accordion-content">
            <p>1. Extract the ZIP file</p>
            <p>2. Open Terminal in the extracted folder</p>
            <p>3. Run:</p>
            <pre style="background: var(--bg-dark); padding: 10px; border-radius: 4px; overflow-x: auto;">npm install
node trackium-location.js</pre>
            <p style="color: var(--success-green); margin-top: 10px;">âœ… Service will start automatically and connect to your MiniDapp</p>
          </div>
        </div>
      </div>

      <!-- Windows Instructions -->
      <div id="instructions-windows" class="platform-instructions" style="display: none;">
        <h4>ğŸªŸ Windows Installation</h4>
        <div class="accordion">
          <button class="accordion-btn" onclick="toggleAccordion(this)">
            Step 1: Download Service â†’
          </button>
          <div class="accordion-content">
            <button class="primary-btn" onclick="downloadLocationService('windows')" style="margin: 15px 0;">
              ğŸ“¥ Download trackium-location-service-windows.zip
            </button>
            <p style="font-size: 13px; color: var(--text-secondary);">
              Version 1.0.0 | Size: ~5MB | Requires: Node.js 16+
            </p>
          </div>

          <button class="accordion-btn" onclick="toggleAccordion(this)">
            Step 2: Install Node.js (if needed) â†’
          </button>
          <div class="accordion-content">
            <p>Check if Node.js is installed (open CMD):</p>
            <pre style="background: var(--bg-dark); padding: 10px; border-radius: 4px; overflow-x: auto;">node --version</pre>
            <p>If not installed, download from: <a href="https://nodejs.org" target="_blank" style="color: var(--primary-blue);">nodejs.org</a></p>
          </div>

          <button class="accordion-btn" onclick="toggleAccordion(this)">
            Step 3: Run Service â†’
          </button>
          <div class="accordion-content">
            <p>1. Extract the ZIP file</p>
            <p>2. Open Command Prompt in the extracted folder</p>
            <p>3. Run:</p>
            <pre style="background: var(--bg-dark); padding: 10px; border-radius: 4px; overflow-x: auto;">npm install
node trackium-location.js</pre>
            <p style="color: var(--success-green); margin-top: 10px;">âœ… Service will start automatically</p>
          </div>
        </div>
      </div>

      <!-- Linux Instructions -->
      <div id="instructions-linux" class="platform-instructions" style="display: none;">
        <h4>ğŸ§ Linux Installation</h4>
        <div class="accordion">
          <button class="accordion-btn" onclick="toggleAccordion(this)">
            Step 1: Download Service â†’
          </button>
          <div class="accordion-content">
            <button class="primary-btn" onclick="downloadLocationService('linux')" style="margin: 15px 0;">
              ğŸ“¥ Download trackium-location-service-linux.tar.gz
            </button>
          </div>

          <button class="accordion-btn" onclick="toggleAccordion(this)">
            Step 2: Install & Run â†’
          </button>
          <div class="accordion-content">
            <pre style="background: var(--bg-dark); padding: 10px; border-radius: 4px; overflow-x: auto;">tar -xzf trackium-location-service-linux.tar.gz
cd trackium-location-service
npm install
node trackium-location.js</pre>
          </div>
        </div>
      </div>

      <!-- Android Instructions -->
      <div id="instructions-android" class="platform-instructions" style="display: none;">
        <h4>ğŸ¤– Android Companion App</h4>
        <p style="margin-bottom: 20px;">
          Download and install the Trackium Companion app to enable background location tracking.
        </p>
        <button class="primary-btn" onclick="downloadAndroidApp()" style="width: 100%; margin-bottom: 15px;">
          ğŸ“¥ Download Trackium Companion APK
        </button>
        <div class="accordion">
          <button class="accordion-btn" onclick="toggleAccordion(this)">
            Installation Steps â†’
          </button>
          <div class="accordion-content">
            <ol style="line-height: 1.8;">
              <li>Download the APK file</li>
              <li>Enable "Install from Unknown Sources" in Settings</li>
              <li>Open the APK and install</li>
              <li>Grant Location permissions when prompted</li>
              <li>Enter your Device ID from Trackium MiniDapp</li>
              <li>App will run in background automatically</li>
            </ol>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
.platform-btn {
  background: var(--bg-medium);
  border: 2px solid var(--border-color);
  border-radius: 12px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
}

.platform-btn:hover {
  border-color: var(--primary-blue);
  transform: translateY(-2px);
}

.platform-btn.selected {
  border-color: var(--primary-blue);
  background: rgba(0, 102, 204, 0.1);
}

.platform-btn p {
  margin-top: 10px;
  font-weight: 600;
  color: var(--text-primary);
}

.accordion {
  margin-top: 20px;
}

.accordion-btn {
  width: 100%;
  background: var(--bg-light);
  border: none;
  padding: 15px;
  text-align: left;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  margin-bottom: 5px;
  transition: all 0.3s;
  color: var(--text-primary);
}

.accordion-btn:hover {
  background: var(--bg-medium);
}

.accordion-content {
  display: none;
  padding: 15px;
  background: var(--bg-dark);
  border-radius: 8px;
  margin-bottom: 10px;
  line-height: 1.6;
}

.accordion-content.active {
  display: block;
}

.platform-instructions {
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
function showLocationServiceModal() {
  document.getElementById('location-service-modal').classList.add('active');
}

function closeLocationServiceModal() {
  document.getElementById('location-service-modal').classList.remove('active');
}

function selectPlatform(platform) {
  // Highlight selected platform
  document.querySelectorAll('.platform-btn').forEach(btn => {
    btn.classList.remove('selected');
  });
  document.querySelector(`[data-platform="${platform}"]`).classList.add('selected');
  
  // Hide all instructions
  document.querySelectorAll('.platform-instructions').forEach(inst => {
    inst.style.display = 'none';
  });
  
  // Show selected platform instructions
  document.getElementById(`instructions-${platform}`).style.display = 'block';
}

function toggleAccordion(button) {
  const content = button.nextElementSibling;
  const isActive = content.classList.contains('active');
  
  // Close all accordions
  document.querySelectorAll('.accordion-content').forEach(c => {
    c.classList.remove('active');
  });
  
  // Open clicked accordion
  if (!isActive) {
    content.classList.add('active');
  }
}

function downloadLocationService(platform) {
  console.log('Downloading location service for:', platform);
  
  // Ğ’ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğµ Ğ·Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ĞµÑ‚ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° GitHub releases
  const downloadLinks = {
    macos: '/downloads/trackium-location-service-macos.zip',
    windows: '/downloads/trackium-location-service-windows.zip',
    linux: '/downloads/trackium-location-service-linux.tar.gz'
  };
  
  // Simulate download (Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ±ÑƒĞ´ĞµÑ‚ fetch/download)
  alert(`Download started for ${platform}!\n\nNote: In production, this will download from GitHub releases.`);
  
  // Show next steps
  if (window.ui) {
    window.ui.showNotification(`Download started for ${platform}`, 'success');
  }
}

function downloadAndroidApp() {
  console.log('Downloading Android companion app');
  alert('Android app download started!\n\nNote: In production, this will download the APK.');
  
  if (window.ui) {
    window.ui.showNotification('Android app download started', 'success');
  }
}

function checkLocationServiceStatus() {
  console.log('Checking location service status...');
  
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· API
  fetch('http://127.0.0.1:9003/api/location/status')
    .then(res => res.json())
    .then(data => {
      const statusDiv = document.getElementById('location-service-status');
      const statusText = document.getElementById('service-status-text');
      const lastUpdate = document.getElementById('service-last-update');
      
      statusDiv.style.display = 'block';
      
      if (data.active) {
        statusText.textContent = 'âœ… Active';
        statusText.style.color = 'var(--success-green)';
        lastUpdate.textContent = new Date(data.lastUpdate).toLocaleString();
      } else {
        statusText.textContent = 'âŒ Not Running';
        statusText.style.color = 'var(--danger-red)';
        lastUpdate.textContent = 'Never';
      }
    })
    .catch(err => {
      console.error('Failed to check status:', err);
      
      const statusDiv = document.getElementById('location-service-status');
      const statusText = document.getElementById('service-status-text');
      
      statusDiv.style.display = 'block';
      statusText.textContent = 'âŒ Service Not Found';
      statusText.style.color = 'var(--danger-red)';
    });
}

function testLocationAPI() {
  console.log('Testing location API...');
  
  if (window.ui) {
    window.ui.showNotification('Testing location service...', 'info');
  }
  
  fetch('http://127.0.0.1:9003/api/location/test')
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(`âœ… Location Service Working!\n\nLat: ${data.latitude}\nLng: ${data.longitude}\nAccuracy: ${data.accuracy}m`);
      } else {
        alert('âŒ Location service returned an error');
      }
    })
    .catch(err => {
      alert('âŒ Cannot connect to location service\n\nMake sure the service is running.');
    });
}
</script>

    <!-- Devices List Screen -->
    <div id="devices" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('dashboard')">â† Back</button>
            <h2>My Devices</h2>
            <button class="icon-btn" onclick="refreshDevices()">ğŸ”„</button>
        </div>

        <div class="devices-grid" id="devices-list"></div>
    </div>

    <!-- Device Detail Screen -->
    <div id="device-detail" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('devices')">â† Back</button>
            <h2 id="device-detail-name">Device Details</h2>
            <button class="icon-btn" onclick="deleteDevice(currentDeviceId)">ğŸ—‘ï¸</button>
        </div>

        <div class="device-detail-container">
            <!-- Device Info -->
            <div class="detail-section">
                <h3>Device Information</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Device ID:</span>
                        <span class="info-value" id="detail-device-id">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Type:</span>
                        <span class="info-value" id="detail-device-type">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="detail-device-status">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Battery:</span>
                        <span class="info-value" id="detail-device-battery">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">GPS Signal:</span>
                        <span class="info-value" id="detail-device-gps">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Sync:</span>
                        <span class="info-value" id="detail-device-sync">-</span>
                    </div>
                </div>
            </div>

            <!-- Current Location -->
            <div class="detail-section">
                <h3>Current Location</h3>
                <div id="device-map" class="map-container">
                    <div class="map-placeholder">
                        <span class="location-icon">ğŸ“</span>
                        <p id="device-coordinates">Waiting for GPS...</p>
                    </div>
                </div>
            </div>

            <!-- Smart Lock Controls (if applicable) -->
            <div class="detail-section" id="lock-controls" style="display: none;">
                <h3>Smart Lock Control</h3>
                <div class="lock-status" id="lock-status-display">
                    <div class="lock-icon" id="lock-icon">ğŸ”’</div>
                    <p id="lock-status-text">Locked</p>
                </div>
                <div class="lock-actions">
                    <button class="primary-btn" onclick="generateUnlockQR()">Generate Unlock QR</button>
                    <button class="secondary-btn" onclick="toggleLock()">Toggle Lock</button>
                </div>
            </div>

            <!-- Movement History -->
            <div class="detail-section">
                <h3>Movement History</h3>
                <div id="movement-history" class="history-list"></div>
            </div>

            <!-- Blockchain Proofs -->
            <div class="detail-section">
                <h3>Blockchain Proofs</h3>
                <button class="secondary-btn" onclick="submitProofOfMovement()">Submit Proof-of-Movement</button>
                <div id="blockchain-proofs" class="proofs-list"></div>
            </div>
        </div>
    </div>

    <!-- Shipments Screen -->
    <div id="shipments" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('dashboard')">â† Back</button>
            <h2>Shipments</h2>
            <button class="primary-btn" onclick="showScreen('create-shipment')">+ New Shipment</button>
        </div>

        <div class="shipments-grid" id="shipments-list"></div>
    </div>

    <!-- Create Shipment Screen -->
    <div id="create-shipment" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('shipments')">â† Back</button>
            <h2>Create Shipment</h2>
        </div>

        <div class="form-container">
            <div class="form-group">
                <label>Shipment ID</label>
                <input type="text" id="shipment-id" class="form-input" placeholder="AUTO-GENERATED">
            </div>

            <div class="form-group">
                <label>Select Device</label>
                <select id="shipment-device" class="form-input"></select>
            </div>

            <div class="form-group">
                <label>Cargo Description</label>
                <textarea id="shipment-cargo" class="form-input" rows="3" placeholder="e.g., Electronics, 50 boxes"></textarea>
            </div>

            <div class="form-group">
                <label>Origin</label>
                <input type="text" id="shipment-origin" class="form-input" placeholder="Starting location">
            </div>

            <div class="form-group">
                <label>Destination</label>
                <input type="text" id="shipment-destination" class="form-input" placeholder="Final destination">
            </div>

            <div class="form-group">
                <label>Expected Delivery</label>
                <input type="datetime-local" id="shipment-delivery" class="form-input">
            </div>

            <button class="primary-btn full-width" onclick="createShipment()">
                <span>Create Shipment</span>
            </button>
        </div>
    </div>

    <!-- Analytics Screen -->
    <div id="analytics" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('dashboard')">â† Back</button>
            <h2>Analytics</h2>
        </div>

        <div class="analytics-container">
            <div class="chart-section">
                <h3>Device Activity (Last 7 Days)</h3>
                <canvas id="activity-chart"></canvas>
            </div>

            <div class="chart-section">
                <h3>Proof-of-Movement Timeline</h3>
                <div id="proof-timeline"></div>
            </div>
        </div>
    </div>

    <!-- Settings Screen -->
    <div id="settings" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('dashboard')">â† Back</button>
            <h2>Settings</h2>
        </div>

        <div class="settings-container">
            <div class="setting-group">
                <h3>Blockchain Settings</h3>
                <div class="setting-item">
                    <label>Auto-submit Proof-of-Movement</label>
                    <input type="checkbox" id="auto-proof" class="toggle">
                </div>
                <div class="setting-item">
                    <label>Proof Frequency (minutes)</label>
                    <input type="number" id="proof-frequency" class="form-input" value="60" min="5">
                </div>
            </div>

            <div class="setting-group">
                <h3>Notifications</h3>
                <div class="setting-item">
                    <label>Movement Alerts</label>
                    <input type="checkbox" id="alert-movement" class="toggle" checked>
                </div>
                <div class="setting-item">
                    <label>Lock Status Changes</label>
                    <input type="checkbox" id="alert-lock" class="toggle" checked>
                </div>
            </div>

            <div class="setting-group">
                <h3>Node Information</h3>
                <div class="info-item">
                    <span class="info-label">Node Address:</span>
                    <span class="info-value" id="node-address">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Balance:</span>
                    <span class="info-value" id="node-balance">-</span>
                </div>
            </div>
        </div>

        <!-- ===== SYSTEM INFO (for Companion App setup) ===== -->
<div id="system-info" style="margin-top: 30px; padding: 12px; border-radius: 10px;
     background: #f3f3f3; font-family: monospace;">

    <h3 style="margin: 0 0 10px 0; font-size: 18px;">ğŸ”§ System Info</h3>

    <div style="margin-bottom: 10px;">
        <strong>MiniDapp UID:</strong>
        <span id="mdapp-uid" style="word-break: break-all;"></span>
        <button onclick="copyUid()" style="margin-left: 10px;">Copy</button>
    </div>

    <div>
        <strong>Node Host:</strong>
        <span id="node-host" style="word-break: break-all;"></span>
        <button onclick="copyHost()" style="margin-left: 10px;">Copy</button>
    </div>
</div>

        <!-- RPC Section -->
<div class="setting-group rpc-section">
  <h3>ğŸ”Œ RPC Access</h3>
  <p style="color: var(--text-secondary); margin-bottom: 15px;">
    Enable RPC to allow external services to communicate with your node.
  </p>
  
  <div class="rpc-status">
    <div class="rpc-indicator" id="rpc-indicator"></div>
    <span id="rpc-status-text">Checking...</span>
  </div>
  
  <button class="primary-btn" id="rpc-enable-btn" onclick="enableRPC()">
    Enable RPC
  </button>
</div>

<!-- âœ… SIMULATOR CONTROLS -->
<div class="setting-group">
  <h3>ğŸ® Simulation Mode</h3>
  <p style="color: var(--text-secondary); margin-bottom: 15px;">
    Generate fake GPS updates for testing (updates every 5 minutes)
  </p>
  
  <div class="setting-item">
    <label>Enable Simulator</label>
    <input type="checkbox" id="simulator-enabled" class="toggle" onchange="toggleSimulator(this.checked)">
  </div>
  
  <div id="simulator-controls" style="display: none; margin-top: 15px;">
    <button class="secondary-btn" onclick="forceSimulatorUpdate()">
      ğŸ”„ Force Update Now
    </button>
  </div>
</div>

        
    </div>

    <!-- QR Modal -->
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Unlock QR Code</h3>
                <button class="close-btn" onclick="closeQRModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="qr-code-container" class="qr-container"></div>
                <p class="qr-instructions">Scan this QR code to unlock the device</p>
                <p class="qr-validity">Valid for: <span id="qr-validity">5 minutes</span></p>
            </div>
        </div>
    </div>

        <!-- ===== FOOTER ===== -->
<footer class="app-footer">
  <div class="footer-main">
    <div class="footer-brand">
      <div class="footer-logo">
        <img src="./assets/img/logo.png" alt="Trackium">
        <h3>Trackium</h3>
      </div>
      <p class="footer-tagline">
        Decentralized IoT & Logistics Security Layer. 
        Secure cargo tracking with blockchain proof-of-movement.
      </p>
    </div>
    
    <div class="footer-column">
      <h4>Navigation</h4>
      <div class="footer-links">
        <a class="footer-link" onclick="showScreen('dashboard')">Dashboard</a>
        <a class="footer-link" onclick="showScreen('devices')">My Devices</a>
        <a class="footer-link" onclick="showScreen('add-device')">Add Device</a>
        <a class="footer-link" onclick="showScreen('shipments')">Shipments</a>
        <a class="footer-link" onclick="showScreen('settings')">Settings</a>
      </div>
    </div>
    
    <div class="footer-column">
      <h4>Modes</h4>
      <div class="footer-links">
        <a class="footer-link" onclick="selectMode('cargo')">Trackium Cargo</a>
        <a class="footer-link" onclick="selectMode('life')">Trackium Life</a>
      </div>
    </div>
  </div>
  
  <div class="footer-bottom">
    <div class="footer-bottom-content">
      <div class="footer-powered">
        Powered by <a href="https://minima.global" target="_blank">Minima</a>
      </div>
      <div class="footer-social">
        <a href="https://x.com/trackium" target="_blank" class="social-link">ğ•</a>
        <a href="https://t.me/trackium" target="_blank" class="social-link">ğŸ“±</a>
        <a href="https://trackium.tech" target="_blank" class="social-link">ğŸŒ</a>
      </div>
    </div>
  </div>
</footer>

    <!-- Scripts -->
    <script src="./assets/js/app.js"></script>

    <!-- GPS Help Modal - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ÑÑ‰Ğ¸Ğ¼ </body> -->


<!-- GPS Help Modal -->
<div id="gps-help-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“ GPS Setup Guide</h3>
      <button class="close-btn" onclick="closeGPSHelpModal()">âœ•</button>
    </div>
    <div class="modal-body" style="text-align: left;">
      <h4 style="color: var(--primary-blue); margin: 20px 0 10px;">ğŸŒ For Web Browsers:</h4>
      <ol style="line-height: 1.8;">
        <li>Click the <strong>ğŸ”’ lock icon</strong> in address bar</li>
        <li>Find <strong>"Location"</strong> permission</li>
        <li>Set to <strong>"Allow"</strong></li>
        <li>Refresh the page</li>
      </ol>

      <h4 style="color: var(--primary-blue); margin: 20px 0 10px;">ğŸ“± For Android Devices:</h4>
      <ol style="line-height: 1.8;">
        <li><strong>Enable GPS:</strong>
          <ul style="margin-left: 20px; margin-top: 5px;">
            <li>Settings â†’ Location â†’ Turn ON</li>
            <li>Set to <strong>"High Accuracy"</strong> mode</li>
          </ul>
        </li>
        <li><strong>Browser Permissions:</strong>
          <ul style="margin-left: 20px; margin-top: 5px;">
            <li>Settings â†’ Apps â†’ [Browser] â†’ Permissions</li>
            <li>Location â†’ <strong>"Allow all the time"</strong></li>
          </ul>
        </li>
      </ol>

      <h4 style="color: var(--primary-blue); margin: 20px 0 10px;">ğŸ For iOS Devices:</h4>
      <ol style="line-height: 1.8;">
        <li>Settings â†’ Privacy â†’ Location Services â†’ ON</li>
        <li>Find your browser (Safari/Chrome)</li>
        <li>Set to <strong>"While Using the App"</strong></li>
        <li>Enable <strong>"Precise Location"</strong></li>
      </ol>

      <div style="margin-top: 20px; padding: 15px; background: rgba(0, 168, 107, 0.1); border-left: 3px solid var(--success-green); border-radius: 4px;">
        <strong>âœ… Test Your GPS:</strong>
        <p style="margin-top: 5px;">
          After enabling permissions, try adding a device again. 
          It may take 10-30 seconds to acquire GPS signal.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
function showGPSHelpModal() {
  document.getElementById('gps-help-modal').classList.add('active');
}

function closeGPSHelpModal() {
  document.getElementById('gps-help-modal').classList.remove('active');
}

// Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ² index.html
function showLocationHelpModal() {
  showGPSHelpModal();
}

    // Check mode on app init
document.addEventListener('DOMContentLoaded', function() {
  const savedMode = localStorage.getItem('trackium_mode');
  
  if (!savedMode) {
    // First time - show mode selector AFTER loading finishes
    // ĞĞ• Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸
    console.log('No saved mode, will show selector when user clicks');
  } else if (savedMode === 'life') {
    // Load life mode directly
    setTimeout(() => {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) loadingScreen.classList.remove('active');
      initLifeMode();
    }, 2000);
  } else {
    // Load cargo mode (default)
    setTimeout(() => {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) loadingScreen.classList.remove('active');
      showScreen('dashboard');
    }, 2000);
  }
});
</script>

<script>
function copyUid() {
    const uid = document.getElementById("mdapp-uid").innerText;
    navigator.clipboard.writeText(uid);
    MDS.log("Copied UID");
}

function copyHost() {
    const host = document.getElementById("node-host").innerText;
    navigator.clipboard.writeText(host);
    MDS.log("Copied Host");
}
</script>

</body>
</html>
